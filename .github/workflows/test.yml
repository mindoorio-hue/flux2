name: Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-mock Pillow

    - name: Verify Dockerfile
      run: |
        echo "=== Checking Dockerfile ==="
        head -10 Dockerfile
        if grep -q "pytorch/pytorch:2.1.0-cuda11.8-cudnn8-devel" Dockerfile; then
          echo "✓ Correct Docker base image"
        else
          echo "✗ Wrong Docker base image!"
          exit 1
        fi

    - name: Run quick tests
      run: |
        python quick_test.py
      continue-on-error: true  # Needs mocking for full run

    - name: Verify Python syntax
      run: |
        python -m py_compile handler.py
        python -m py_compile client_example.py
        echo "✓ Python syntax check passed"

    - name: Check project structure
      run: |
        test -f handler.py && echo "✓ handler.py exists"
        test -f requirements.txt && echo "✓ requirements.txt exists"
        test -f Dockerfile && echo "✓ Dockerfile exists"
        test -d src && echo "✓ src/ directory exists"
        test -d tests && echo "✓ tests/ directory exists"
